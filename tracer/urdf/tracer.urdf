<?xml version="1.0"?>
<robot name="tracer">

<!-- material color setting -->
<material name="#ffffff">
  <color rgba="1.000 1.000 1.000 1.0"/>
</material>
<material name="#ff6c6d">
  <color rgba="1.000 0.424 0.431 1.0"/>
</material>
<material name="#313c7e">
  <color rgba="0.196 0.239 0.498 1.0"/>
</material>
<material name="#f8ff80">
  <color rgba="0.976 1.000 0.502 1.0"/>
</material>

  <link name="base_link">
  '''
  When try to view URDF base_link needs inertial properties
  But in gazebo sim root link do not prefer inertial properties
  So, commented out inertial section for base_link
  '''
    <!-- <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.001"/>
      <inertia ixx="0.01" ixy="0.0" ixz="0.0" iyy="0.01" iyz="0.0" izz="0.01"/>
    </inertial> -->
  </link>

  <joint name="base_link_to_base_link_1" type="fixed">
    <origin xyz="0 0 0" rpy="0.0 0.0 1.57"/>
    <axis xyz="1 0 0"/>
    <parent link="base_link"/>
    <child link="base_link_1"/>
    <limit lower="-3.14159" upper="3.14159" effort="0" velocity="0"/>
  </joint>
<!-- original mass = 2.44 kg  -->
  <link name="base_link_1">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="1.440000"/>
      <!-- <inertia ixx="0.009885" ixy="0.000039" ixz="-0.000327" iyy="0.005662" iyz="0.000294" izz="0.010064"/> -->
      <inertia ixx="5e-3" ixy="0.0" ixz="-0.0" iyy="5e-3" iyz="0.0" izz="5e-3"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/base_link.stl"/>
      </geometry>
      <material name="#ff6c6d"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/base_link.stl"/>
      </geometry>
    </collision>
  </link>
  '''
  All prop rotations are indefinite so continuous joint type is used
  '''
  <joint name="base_link_1_to_prop" type="continuous">
    <!-- <origin xyz="0.143571 -0.23628 -0.0316" rpy="0.0 0.0 0.0"/> -->
    <origin xyz="0.15 -0.2245 -0.0316" rpy="0.0 0.0 0.0"/>
    <axis xyz="0 0 1"/>
    <parent link="base_link_1"/>
    <child link="prop"/>
    <!-- <limit lower="-3.14159" upper="3.14159" effort="0" velocity="0"/> -->
  </joint>

  <link name="prop">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.001"/>
      <inertia ixx="1e-7" ixy="0.0" ixz="0.0" iyy="1e-7" iyz="0.0" izz="1e-7"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
      <material name="#f8ff80"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_link_1_to_prop_1" type="continuous">
    <!-- <origin xyz="0.143571 0.21328 -0.0316" rpy="0.0 0.0 0.0"/> -->
    <origin xyz="0.15 0.2245 -0.0316" rpy="0.0 0.0 0.0"/>
    <axis xyz="0 0 1"/>
    <parent link="base_link_1"/>
    <child link="prop_1"/>
    <!-- <limit lower="-3.14159" upper="3.14159" effort="0" velocity="0"/> -->
  </joint>

  <link name="prop_1">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.004"/>
      <inertia ixx="1e-7" ixy="0.0" ixz="0.0" iyy="1e-7" iyz="0.0" izz="1e-7"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
      <material name="#f8ff80"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_link_1_to_prop_2" type="continuous">
    <!-- <origin xyz="-0.157 -0.23628 -0.0316" rpy="0.0 0.0 0.0"/> -->
    <origin xyz="-0.15 -0.2245 -0.0316" rpy="0.0 0.0 0.0"/>
    <axis xyz="0 0 1"/>
    <parent link="base_link_1"/>
    <child link="prop_2"/>
  </joint>

  <link name="prop_2">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.004"/>
      <inertia ixx="1e-7" ixy="0.0" ixz="0.0" iyy="1e-7" iyz="0.0" izz="1e-7"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
      <material name="#f8ff80"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_link_1_to_prop_3" type="continuous">
    <!-- <origin xyz="-0.157 0.212838 -0.0316" rpy="0.0 0.0 0.0"/> -->
    <origin xyz="-0.15 0.2245 -0.0316" rpy="0.0 0.0 0.0"/>
    <axis xyz="0 0 1"/>
    <parent link="base_link_1"/>
    <child link="prop_3"/>
    <!-- <limit lower="-3.14159" upper="3.14159" effort="0" velocity="0"/> -->
  </joint>

  <link name="prop_3">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.004"/>
      <inertia ixx="1e-7" ixy="0.0" ixz="0.0" iyy="1e-7" iyz="0.0" izz="1e-7"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
      <material name="#f8ff80"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/prop.stl"/>
      </geometry>
    </collision>
  </link>

  <joint name="base_link_1_to_cam" type="revolute">
    <origin xyz="-0.007 -0.125 0.027" rpy="0 1.57 0.0"/> 
    <parent link="base_link_1"/>
    <child link="cam"/>
    <axis xyz="0 0 1"/> <limit lower="-1.57" upper="1.57" effort="10" velocity="10"/>
  </joint>

  

  <link name="cam">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass value="0.012"/>
      <inertia ixx="0.000028" ixy="0.000000" ixz="0.000000" iyy="0.000037" iyz="0.000000" izz="0.000023"/>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/cam.stl"/>
      </geometry>
      <material name="#313c7e"/>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh filename="file:///home/deen/ros2_ws/src/tracer/meshes/cam.stl"/>
      </geometry>
    </collision>
  </link>
  
  <gazebo>
    <plugin
      filename="gz-sim-joint-position-controller-system"
      name="gz::sim::systems::JointPositionController">
      <joint_name>base_link_1_to_cam</joint_name>
      <topic>/model/tracer/camera/pitch_cmd</topic>
      <p_gain>0.001</p_gain>
      <i_gain>0.000001</i_gain>
      <d_gain>0.0005</d_gain>
    </plugin>
  </gazebo>

  <gazebo reference="cam">
    <sensor name="camera" type="camera">
      <pose>0 -0.1 0 1.57 0 -1.57</pose>
      <visualize>true</visualize>
      <update_rate>30</update_rate>
      <camera>
        <horizontal_fov>1.047</horizontal_fov>
        <image>
          <width>320</width>
          <height>240</height>
          <!-- <format>R8G8B8</format> -->
        </image>
        <clip>
          <near>0.1</near>
          <far>100</far>
        </clip>
      </camera>
      <topic>/camera</topic>
    </sensor>
  </gazebo>

  <gazebo>
    <!-- <plugin filename="gz-sim-joint-state-publisher-system" name="gz::sim::systems::JointStatePublisher">
      <topic>/world/tracer/model/tracer_drone/joint_state</topic>
    </plugin> -->

    <plugin
      filename="ignition-gazebo-odometry-publisher-system"
      name="ignition::gazebo::systems::OdometryPublisher">
      <odom_frame>world</odom_frame>
      <robot_base_frame>base_link</robot_base_frame>
      <odom_topic>/model/tracer/odometry</odom_topic>
      <dimensions>3</dimensions>
    </plugin>



'''
Multicopter velocity controller demo

You can use the velocity controller and command linear velocity and yaw angular velocity in the body frame of the vehicle

  Send commands to the quadcopter to go straight up:

    ign topic -t "/tracer/gazebo/command/twist" -m ignition.msgs.Twist -p "linear: {x:0 y: 0 z: 0.1} angular {z: 0}"

  To hover

    ign topic -t "/tracer/gazebo/command/twist" -m ignition.msgs.Twist -p " "

  Listen to odometry:

    ign topic -e -t "/model/tracer/odometry"

  Listen to poses:

    ign topic -e -t "/model/tracer/pose

'''


    <plugin
      filename="ignition-gazebo-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>tracer</robotNamespace>
      <jointName>base_link_1_to_prop_2</jointName>
      <linkName>prop_2</linkName>
      <turningDirection>ccw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>800.0</maxRotVelocity>
      <motorConstant>8.54858e-06</motorConstant>
      <momentConstant>0.016</momentConstant>
      <commandSubTopic>gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>0</motorNumber>
      <rotorDragCoefficient>8.06428e-05</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>motor_speed/0</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
      <motorType>velocity</motorType>
    </plugin>
    <plugin
      filename="ignition-gazebo-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>tracer</robotNamespace>
      <jointName>base_link_1_to_prop_1</jointName>
      <linkName>prop_1</linkName>
      <turningDirection>ccw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>800.0</maxRotVelocity>
      <motorConstant>8.54858e-06</motorConstant>
      <momentConstant>0.016</momentConstant>
      <commandSubTopic>gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>1</motorNumber>
      <rotorDragCoefficient>8.06428e-05</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>motor_speed/1</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
      <motorType>velocity</motorType>
    </plugin>
    <plugin
      filename="ignition-gazebo-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>tracer</robotNamespace>
      <jointName>base_link_1_to_prop</jointName>
      <linkName>prop</linkName>
      <turningDirection>cw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>800.0</maxRotVelocity>
      <motorConstant>8.54858e-06</motorConstant>
      <momentConstant>0.016</momentConstant>
      <commandSubTopic>gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>2</motorNumber>
      <rotorDragCoefficient>8.06428e-05</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>motor_speed/2</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
      <motorType>velocity</motorType>
    </plugin>
    <plugin
      filename="ignition-gazebo-multicopter-motor-model-system"
      name="gz::sim::systems::MulticopterMotorModel">
      <robotNamespace>tracer</robotNamespace>
      <jointName>base_link_1_to_prop_3</jointName>
      <linkName>prop_3</linkName>
      <turningDirection>cw</turningDirection>
      <timeConstantUp>0.0125</timeConstantUp>
      <timeConstantDown>0.025</timeConstantDown>
      <maxRotVelocity>800.0</maxRotVelocity>
      <motorConstant>8.54858e-06</motorConstant>
      <momentConstant>0.016</momentConstant>
      <commandSubTopic>gazebo/command/motor_speed</commandSubTopic>
      <motorNumber>3</motorNumber>
      <rotorDragCoefficient>8.06428e-05</rotorDragCoefficient>
      <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
      <motorSpeedPubTopic>motor_speed/3</motorSpeedPubTopic>
      <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
      <motorType>velocity</motorType>
    </plugin>


    <plugin
      filename="ignition-gazebo-multicopter-control-system"
      name="gz::sim::systems::MulticopterVelocityControl">
      <robotNamespace>tracer</robotNamespace>
      <!-- <commandSubTopic>gazebo/command/twist</commandSubTopic> -->
      <commandSubTopic>cmd_vel</commandSubTopic>
      <enableSubTopic>enable</enableSubTopic>
      <comLinkName>base_link</comLinkName>
      <velocityGain>2.7 2.7 2.7</velocityGain>
      <attitudeGain>2 3 0.15</attitudeGain>
      <angularRateGain>0.4 0.52 0.18</angularRateGain>
      <maximumLinearAcceleration>2 2 2</maximumLinearAcceleration>

      <rotorConfiguration>
        <rotor>
          <jointName>base_link_1_to_prop_2</jointName>
          <forceConstant>8.54858e-06</forceConstant>
          <momentConstant>0.016</momentConstant>
          <direction>1</direction>
        </rotor>
        <rotor>
          <jointName>base_link_1_to_prop_1</jointName>
          <forceConstant>8.54858e-06</forceConstant>
          <momentConstant>0.016</momentConstant>
          <direction>1</direction>
        </rotor>
        <rotor>
          <jointName>base_link_1_to_prop</jointName>
          <forceConstant>8.54858e-06</forceConstant>
          <momentConstant>0.016</momentConstant>
          <direction>-1</direction>
        </rotor>
        <rotor>
          <jointName>base_link_1_to_prop_3</jointName>
          <forceConstant>8.54858e-06</forceConstant>
          <momentConstant>0.016</momentConstant>
          <direction>-1</direction>
        </rotor>
      </rotorConfiguration>
    </plugin>

  </gazebo>


</robot>
